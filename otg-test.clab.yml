name: otg-test

topology:
  nodes:
    spine1:
      kind: ceos
      image: ceos:4.33.4M
      mgmt-ipv4: 172.20.20.35
      startup-config: configs/spine1.cfg
    spine2:
      kind: ceos
      image: ceos:4.33.4M
      mgmt-ipv4: 172.20.20.36
      startup-config: configs/spine2.cfg

    leaf1:
      kind: ceos
      image: ceos:4.33.4M
      mgmt-ipv4: 172.20.20.31
      startup-config: configs/leaf1.cfg
    leaf2:
      kind: ceos
      image: ceos:4.33.4M
      mgmt-ipv4: 172.20.20.32
      startup-config: configs/leaf2.cfg

    leaf3:
      kind: ceos
      image: ceos:4.33.4M
      mgmt-ipv4: 172.20.20.33
      startup-config: configs/leaf3.cfg
    leaf4:
      kind: ceos
      image: ceos:4.33.4M
      mgmt-ipv4: 172.20.20.34
      startup-config: configs/leaf4.cfg

    otg:
      kind: keysight_ixia-c-one
      image: ghcr.io/open-traffic-generator/ixia-c-one:latest
      mgmt-ipv4: 172.20.20.37

    # Telemetry Stack
    gnmic:
      kind: linux
      image: ghcr.io/openconfig/gnmic:latest
      mgmt-ipv4: 172.20.20.41
      binds:
        - telemetry/gnmic-config.yml:/gnmic-config.yml:ro
      cmd: --config /gnmic-config.yml --log subscribe
      group: telemetry

    prometheus:
      kind: linux
      image: prom/prometheus:latest
      mgmt-ipv4: 172.20.20.42
      binds:
        - telemetry/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      cmd: --config.file=/etc/prometheus/prometheus.yml
      ports:
        - 9091:9090
      group: telemetry

    grafana:
      kind: linux
      image: grafana/grafana:latest
      mgmt-ipv4: 172.20.20.43
      binds:
        - telemetry/grafana/datasources/datasource.yaml:/etc/grafana/provisioning/datasources/datasource.yaml:ro
        - telemetry/grafana/dashboards.yaml:/etc/grafana/provisioning/dashboards/dashboards.yaml:ro
        - telemetry/grafana/dashboards:/var/lib/grafana/dashboards
      ports:
        - 3000:3000
      env:
        GF_INSTALL_PLUGINS: "grafana-clock-panel,grafana-simple-json-datasource"
        GF_SECURITY_ADMIN_USER: "admin"
        GF_SECURITY_ADMIN_PASSWORD: "admin"
        GF_AUTH_ANONYMOUS_ENABLED: "true"
      group: telemetry

    loki:
      kind: linux
      image: grafana/loki:2.9.10
      mgmt-ipv4: 172.20.20.44
      binds:
        - telemetry/loki-config.yml:/etc/loki/local-config.yaml:ro
      cmd: -config.file=/etc/loki/local-config.yaml
      ports:
        - 3100:3100
      group: telemetry

    promtail:
      kind: linux
      image: grafana/promtail:2.9.10
      mgmt-ipv4: 172.20.20.45
      binds:
        - telemetry/promtail-config.yml:/etc/promtail/config.yml:ro
      cmd: -config.file=/etc/promtail/config.yml
      ports:
        - 1514:1514/udp
      group: telemetry

  links:
    # Spine1 Connections
    - endpoints: ["spine1:eth1", "leaf1:eth1"]
    - endpoints: ["spine1:eth2", "leaf2:eth1"]
    - endpoints: ["spine1:eth3", "leaf3:eth1"]
    - endpoints: ["spine1:eth4", "leaf4:eth1"]

    # Spine2 Connections
    - endpoints: ["spine2:eth1", "leaf1:eth2"]
    - endpoints: ["spine2:eth2", "leaf2:eth2"]
    - endpoints: ["spine2:eth3", "leaf3:eth2"]
    - endpoints: ["spine2:eth4", "leaf4:eth2"]

    # Leaf MLAG Peer Links (Pair 1: Leaf1-Leaf2)
    - endpoints: ["leaf1:eth3", "leaf2:eth3"] # Peer Link 1
    - endpoints: ["leaf1:eth4", "leaf2:eth4"] # Peer Link 2

    # Leaf MLAG Peer Links (Pair 2: Leaf3-Leaf4)
    - endpoints: ["leaf3:eth3", "leaf4:eth3"] # Peer Link 1
    - endpoints: ["leaf3:eth4", "leaf4:eth4"] # Peer Link 2

    # OTG Connections
    # Port 1 (Leaf1/2 side) - Connected to Leaf1 and Leaf2 for MLAG LAG
    - endpoints: ["otg:eth1", "leaf1:eth5"]
    - endpoints: ["otg:eth2", "leaf2:eth5"]

    # Port 2 (Leaf3/4 side) - Connected to Leaf3 and Leaf4 for MLAG LAG
    - endpoints: ["otg:eth3", "leaf3:eth5"]
    - endpoints: ["otg:eth4", "leaf4:eth5"]
